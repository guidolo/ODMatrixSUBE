
CREATE TABLE PTOCONTROL201505
(
  CODIGOLINEA character varying(50),
  RAMAL character varying(5),
  FILE_ID integer,
  C_CONTROL_POINT integer,
  LONGITUD numeric,
  LATITUD numeric,
  FECHAPTO date,
  ESTADO character(1),
  DIFSEC real,
  SEGUNDOSPTO real,
  MINFECHAINGRESO date
);

SET datestyle = "ISO, DMY";

COPY PTOCONTROL201505 FROM 'E:\pruebas\PUNTOSCONTROL.CSV' CSV  DELIMITER ';'  HEADER;


select * from PTOCONTROL201505;

ALTER TABLE PTOCONTROL201505
ADD SENTIDO character varying(2),
ADD distruta numeric;


--no hay puntos de control duplicados
SELECT *
FROM SENTIDO 
WHERE FILE_ID IN (
			SELECT DISTINCT  FILE_ID
			FROM SENTIDO
			GROUP BY FILE_ID, C_CONTROL_POINT
			HAVING COUNT(*) > 1)
ORDER BY FILE_ID, C_CONTROL_POINT;

			SELECT DISTINCT  FILE_ID
			FROM SENTIDO
			WHERE TO_NUMBER(LINEA, '999') NOT IN (41,70,145, 159,182,138,142,150,151,42,53,66,71, 87, 
			101,119,147,190,191,265,619,85,100,106,110,123,127,130,141,154,
			156,170,179,180,184,257,330,43,63,103,133,153,155,165,172,193,
			385,35,55,67,76,79,143,278,50,57,107,220,224,310,315)
			GROUP BY FILE_ID, C_CONTROL_POINT
			HAVING COUNT(*) > 1;

UPDATE PTOCONTROL201505 SET SENTIDO = NULL, DISTRUTA = NULL WHERE CODIGOLINEA <> '145';

UPDATE PTOCONTROL201505 A
SET SENTIDO = B.SENTIDO
FROM SENTIDO B 
WHERE TO_NUMBER(LINEA, '999') IN (41,70,145, 159,182,138,142,150,151,42,53,66,71, 87, 
			101,119,147,190,191,265,619,85,100,106,110,123,127,130,141,154,
			156,170,179,180,184,257,330,43,63,103,133,153,155,165,172,193,
			385,35,55,67,76,79,143,278,50,57,107,220,224,310,315)
AND  A.FILE_ID = B.FILE_ID AND A.C_CONTROL_POINT = B.C_CONTROL_POINT;

UPDATE PTOCONTROL201505 A
SET distruta = B.distaida
FROM SENTIDO B 
WHERE TO_NUMBER(LINEA, '999') IN (41,70,145, 159,182,138,142,150,151,42,53,66,71, 87, 
			101,119,147,190,191,265,619,85,100,106,110,123,127,130,141,154,
			156,170,179,180,184,257,330,43,63,103,133,153,155,165,172,193,
			385,35,55,67,76,79,143,278,50,57,107,220,224,310,315)
AND A.FILE_ID = B.FILE_ID AND A.C_CONTROL_POINT = B.C_CONTROL_POINT AND B.SENTIDO = 'I';

UPDATE PTOCONTROL201505 A
SET distruta = B.distavuelta
FROM SENTIDO B 
WHERE TO_NUMBER(LINEA, '999')  IN (41,70,145, 159,182,138,142,150,151,42,53,66,71, 87, 
			101,119,147,190,191,265,619,85,100,106,110,123,127,130,141,154,
			156,170,179,180,184,257,330,43,63,103,133,153,155,165,172,193,
			385,35,55,67,76,79,143,278,50,57,107,220,224,310,315)
AND  A.FILE_ID = B.FILE_ID AND A.C_CONTROL_POINT = B.C_CONTROL_POINT AND B.SENTIDO = 'V';


/*control*/
select CODIGOLINEA, sentido, count(*) 
from PTOCONTROL201505 
where sentido is not null
group by codigolinea, sentido
order by codigolinea, sentido;



--DROP INDEX  ptocontrol201505_idx;

CREATE INDEX ptocontrol201505_idx
  ON ptocontrol201505
  USING btree
  (file_id, c_control_point, SENTIDO);


/*---------- nueva version de PTO DE CONTROL*/
CREATE TABLE PTOCONTROL201505b
(
  file_id integer,
  c_control_point integer,
  longitud numeric,
  latitud numeric,
  segundospto real
);

SET datestyle = "ISO, DMY";

COPY PTOCONTROL201505B FROM 'E:\pruebas\PTOCONTROL201505C.CSV' CSV  DELIMITER ';'  HEADER;

drop INDEX ptocontrol201505b_idx;

CREATE INDEX ptocontrol201505b_idx
  ON ptocontrol201505b
  (file_id);

ALTER TABLE PTOCONTROL201505b
ADD SENTIDO character varying(2);

SELECT * FROM pg_stat_activity ;

SELECT * FROM PTOCONTROL201505B where sentido is not null order by file_id, c_control_point;


SELECT COUNT(DISTINCT IDARCHIVOINTERCAMBIO) FROM THE_VIAJESMAYO;
--16870

SELECT COUNT(DISTINCT A.IDARCHIVOINTERCAMBIO) 
FROM THE_VIAJESMAYO A, THE_LOTES B
WHERE A.IDARCHIVOINTERCAMBIO = B.IDARCHIVOINTERCAMBIO;
--16794

with lotesmayo as (
	SELECT DISTINCT B.FILE_ID
	FROM THE_VIAJESMAYO A, THE_LOTES B
	WHERE A.IDARCHIVOINTERCAMBIO = B.IDARCHIVOINTERCAMBIO
)
SELECT COUNT(DISTINCT C.FILE_ID) 
FROM LOTESMAYO A, PTOCONTROL201505B C
WHERE  A.FILE_ID = C.FILE_ID;
--15068










